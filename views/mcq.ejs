<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice & Excel</title>
    <%- include('partials/headlinks.ejs') %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }

        body {
            background: #ffffff !important;
        }


        .fa-sign-in-alt {
            font-size: 27px;
            color: #FF6B6B;
            /* Change the color to your preference */
            margin: 0 10px;
            /* Add spacing around the icon */
        }

        .fa-sign-in-alt:hover {
            color: rgb(206, 206, 247);
        }

        .app {
            /* background: #ffdf6a; */
            background-color: #dfdfdf54;
            /* box-shadow: 3px 3px 10px rgb(137, 137, 137); */

            width: 90%;
            max-width: 600px;
            margin: 40px auto;
            border-radius: 10px;
            padding: 30px;

        }

        .app h1 {
            color: #001e4d;
            font-weight: bold;
            padding-bottom: 30px;

        }

        .quiz {
            padding: 20px 0;

        }

        .quiz h2 {
            font-size: 18px;
            font-weight: bold;

        }

        .btn1 {
            background: #fff;
            color: #222;
            font-weight: 500;
            width: 100%;
            border: 1px #efefef;
            padding: 10px;
            margin: 10px;
            text-align: left;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;

        }

        /* .btn1:hover:not([disabled]) {
        background: #222;
        color: #fff;
    } */

        .btn1:disabled {
            cursor: no-drop;
        }


        #next-btn{
            font-weight: 500;
            width: 150px;
            border: 0;
            padding: 10px;
            margin: 20px auto 0;
            border-radius: 40px;
            /* cursor: pointer; */
            display: none;
        }
        #next-btn:disabled {
            /* background: #23a139; */
            background: #b1b1b1;
            color: #202020;
            
            cursor:not-allowed;
        }
        #next-btn:enabled{
            color: white;
            background-color: #23a139;
            cursor: pointer;
        }

        .correct {
            background: #6ddd9c;
        }

        .incorrect {
            background: #f37070;
        }

        /*  ------------------------------------css for footer----------------------------------------- */
        @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500;600;700;800;900&display=swap");




        .footer {
            /* background: transparent; */
            background-color: rgb(22, 22, 22);
            /* min-height: 365px; */
            margin-top: 180px;
            padding: 30px 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .social-icon,
        .menu {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .social-icon__item,
        .menu__item {
            list-style: none;
        }

        .social-icon__link {
            font-size: 2rem;
            color: #fff;
            margin: 0 10px;
            display: inline-block;
            transition: 0.5s;
        }

        .social-icon__link:hover {
            transform: translateY(-10px);
        }

        .menu__link {
            font-size: 1.2rem;
            color: #fff;
            margin: 0 10px;
            display: inline-block;
            transition: 0.5s;
            text-decoration: none;
            opacity: 0.75;
            font-weight: 300;
        }

        .menu__link:hover {
            opacity: 1;
        }

        .footer p {
            color: #fff;
            text-align: center;
            letter-spacing: 5px;
            margin: 15px 0 10px 0;
            font-size: 1rem;
            font-weight: 300;
        }

        /*    responsive code-------------------------------------------------- */

        #hud {
            display: flex;
            justify-content: space-between;
        }

        #hud-item {
            width: 100%;
        }

        .hud-prefix {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
        }

        .hud-main-text {
            text-align: center;
        }

        #progressBar {
            width: 100%;
            height: 5px;
            background-color: rgb(255, 255, 255);
            /* border: 0.3rem solid #56a5eb; */
            margin-top: 1.5rem;
        }

        #progressBarFull {
            /* height: 1.4rem; */
            height: 5px;
            background-color: #0088ff;
            width: 0%;
        }

        #quote {
            text-align: center;
            margin: 20px 0;
        }

        /* loader */

.loading{
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: white;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 100;
}
.hide{
    display: none;
}

.loader {
    width: 48px;
    height: 48px;
    margin: auto;
    position: relative;
  }
  .loader:before {
      content: '';
      width: 48px;
      height: 5px;
      background: #000;
      opacity: 0.25;
      position: absolute;
      top: 60px;
      left: 0;
      border-radius: 50%;
      animation: shadow 0.5s linear infinite;
    }
    .loader:after {
      content: '';
      width: 48px;
      height: 48px;
      background: #ff9b9b;
      animation: bxSpin 0.5s linear infinite;
      position: absolute;
      top: 0;
      left: 0;
      border-radius: 4px;
    }
  @keyframes bxSpin {
    17% {
      border-bottom-right-radius: 3px;
    }
    25% {
      transform: translateY(9px) rotate(22.5deg);
    }
    50% {
      transform: translateY(18px) scale(1, .9) rotate(45deg);
      border-bottom-right-radius: 40px;
    }
    75% {
      transform: translateY(9px) rotate(67.5deg);
    }
    100% {
      transform: translateY(0) rotate(90deg);
    }
  }

  @keyframes shadow {
    0%, 100% {
      transform: scale(1, 1);
    }
    50% {
      transform: scale(1.2, 1);
    }
  }
    </style>
</head>

<body>    
    <%- include('partials/navbar.ejs') %>

      <div class="level" style="width: 160px; margin: 30px auto;color: white; background-color: #0088ff; padding: 3px 2px;border-radius: 8px;padding-top: 10px;">
          <h6 style="text-align: center;"><span id="mcqLevel"></span></h6> 
      </div>
      <div style="min-height: 100vh;">
    
    <div class="app" style="margin-bottom: 100px;">
        <!-- <h1> Quiz </h1> -->
        <div id="hud">
            <div id="hud-item">
                <p id="progressText" class="hud-prefix">
                    Practice & Excel 
                </p>
                <div id="progressBar">
                    <div id="progressBarFull"></div>
                </div>
            </div>
        </div>
        <div class="quiz">
            <h2 id="question">Question ?</h2>
            <div id="answer-buttons">
                <button class="btn1">Answer 1</button>
                <button class="btn1">Answer 2</button>
                <button class="btn1">Answer 3</button>
                <button class="btn1">Answer 4</button>
            </div>
            <p id="ans-exp" style="text-align:center; margin-top: 12px;">explaination</p>
            <button id="next-btn" disabled>Next</button>
        </div>

        <div style="width: 300px; margin: auto;">

            <!-- Example 3 -->
            <canvas id="pieChart3" style="display: none;"></canvas>

        </div>
        <p id="quote" style="font-style: italic; color: grey;"></p>
    </div>
</div>

    <!------------------------------------------- footer starts here  -------------------------------------------------------------->
    <%- include('partials/footer.ejs') %>
    <!------------------------------------------- footer Ended here -------------------------------------------------------------->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
    <script>
        Chart.defaults.RoundedDoughnut = Chart.helpers.clone(Chart.defaults.doughnut);
        Chart.controllers.RoundedDoughnut = Chart.controllers.doughnut.extend({
            draw: function (ease) {
                var ctx = this.chart.ctx;
                var easingDecimal = ease || 1;
                var arcs = this.getMeta().data;
                Chart.helpers.each(arcs, function (arc, i) {
                    arc.transition(easingDecimal).draw();

                    var pArc = arcs[i === 0 ? arcs.length - 1 : i - 1];
                    var pColor = pArc._view.backgroundColor;

                    var vm = arc._view;
                    var radius = (vm.outerRadius + vm.innerRadius) / 2;
                    var thickness = (vm.outerRadius - vm.innerRadius) / 2;
                    var startAngle = Math.PI - vm.startAngle - Math.PI / 2;
                    var angle = Math.PI - vm.endAngle - Math.PI / 2;

                    ctx.save();
                    ctx.translate(vm.x, vm.y);

                    ctx.fillStyle = i === 0 ? vm.backgroundColor : pColor;
                    ctx.beginPath();
                    ctx.arc(radius * Math.sin(startAngle), radius * Math.cos(startAngle), thickness, 0, 2 * Math.PI);
                    ctx.fill();

                    ctx.fillStyle = vm.backgroundColor;
                    ctx.beginPath();
                    ctx.arc(radius * Math.sin(angle), radius * Math.cos(angle), thickness, 0, 2 * Math.PI);
                    ctx.fill();

                    ctx.restore();
                });
            }
        });

        let questions = [];
        let endQuote = "";
        const questionElement = document.getElementById("question");
        const answerButton = document.getElementById("answer-buttons");
        const nextButton = document.getElementById("next-btn");
        const explaination = document.getElementById("ans-exp");
        const scoreEle = document.getElementById("score");
        const quote = document.getElementById("quote");
        const progressBarFull = document.getElementById("progressBarFull");
        const quizapp = document.querySelector(".app");
        const mcqLevel = document.getElementById('mcqLevel');
        let currentQuestionIndex = 0;
        let score = 0;
        let attempt = 0;
        let category;


        async function getQsns() {
            try {
                const params = new URLSearchParams(window.location.search);
                category = params.get('category');
                let Class = parseInt("<%- locals.Class %>")
                if(Class <= 3){
                    throw new Error("class 1-3");
                }
                const response = await fetch(`${window.location.origin}/mcq/${category}`);
                let jsonResp = await response.json();
                console.log(jsonResp);
                questions = jsonResp.qsn;
                endQuote = jsonResp.quote;
                mcqLevel.textContent = jsonResp.currlevel;

                if (questions.length === 0) {
                    quizapp.innerHTML = `<div style="text-align:center"><h4 style="text-align:center">Something went wrong</h4>
            <a href="/">Home</a></div>`
                    return;
                }
                startQuiz();
            } catch(err) {
                questions = [];
                if(err.message === "class 1-3"){
                    quizapp.innerHTML = `<div style="text-align:center"><h4 style="text-align:center">Mcq section not available for class less than 4</h4>
            <a href="/">Home</a></div>`    
            return;
                }
                quizapp.innerHTML = `<div style="text-align:center"><h4 style="text-align:center">Something went wrong</h4>
            <a href="/">Home</a></div>`
            } 

            return;
        }
        getQsns();

        function createAns(opt, correct, currentQuestion) {
            const button = document.createElement("button");
            button.innerHTML = opt;
            button.classList.add("btn1");
            answerButton.appendChild(button);
            if (currentQuestion.correct === correct) {
                button.dataset.correct = true
            }
            button.addEventListener("click", selectAnswer);
        }

        function showQuestion() {
            resetState();
            let currentQuestion = questions[currentQuestionIndex];
            let questionNo = currentQuestionIndex + 1;
            questionElement.innerHTML = `${currentQuestion.qsn}`;
            explaination.innerHTML = `<h5 style="font-weight:600;text-decoration:underline">Explanation</h5> <p>${currentQuestion.exp}</p>`;
            let randomOpt = [
                ['A','B','C','D'],
                ['B','D','A','C'],
                ['D','A','B','C'],
                ['D','B','C','A'],
                ['B','C','A','D'],
                ['A','B','D','C'],
                ['A','C','D','B'],
                ['A','D','B','C'],
                ['C','D','A','B'],
                ['D','C','B','A'],
                ['C','A','D','B'],
            ]

            let random = randomOpt[Math.floor(1 + Math.random()*(randomOpt.length -1))];

            for(i=0;i<4;i++){
                let opt = `opt${random[i]}`;
                createAns(currentQuestion[`${opt}`],`${random[i]}`,currentQuestion);
            }
            // createAns(currentQuestion.optA, 'A', currentQuestion);
            // createAns(currentQuestion.optB, 'B', currentQuestion);
            // createAns(currentQuestion.optC, 'C', currentQuestion);
            // createAns(currentQuestion.optD, 'D', currentQuestion);

        }

        function startQuiz() {
            // getQsns();
            currentQuestionIndex = 0;
            score = 0;
            nextButton.innerHTML = "5";
            // explaination.textContent = "explanation"
            quote.textContent = "";
            progressBarFull.style.width = `0%`;
            showQuestion();
        }

        function resetState() {
            nextButton.style.display = "none";
            explaination.style.display = "none";
            attempt = 0;
            var ctx3 = document.getElementById("pieChart3");
            ctx3.style.display = "none";
            while (answerButton.firstChild) {
                answerButton.removeChild(answerButton.firstChild);
            }
        }

        async function submit() {
            await fetch(`${window.location.origin}/submit`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    category: category,
                    Attempt: questions.length,
                    Correct: score,
                    Wrong: (questions.length - score),
                }),
            });
        }

        function selectAnswer(e) {
            const selectedBtn = e.target;
            const iscorrect = selectedBtn.dataset.correct === "true";
            attempt++;
            if (iscorrect) {
                selectedBtn.classList.add("correct");
                nextButton.disabled = true;
                nextButton.textContent = '5';
                Array.from(answerButton.children).forEach(button => {
                    if (button.dataset.correct === "true") {
                        button.classList.add("correct");
                    }
                    button.disabled = true;
                });

                nextButton.style.display = "block";
                let itr = 4;
                let next5 = setInterval(()=>{
                    if(itr <= 0){
                        nextButton.disabled = false
                        // nextButton.style.color = '#fff'
                        // nextButton.style.background = '#23a139'
                        // nextButton.style.cursor = 'pointer'
                        nextButton.textContent = 'Next';
                        clearInterval(next5);
                    }
                    else{
                        nextButton.textContent = itr;
                        itr--;
                    }
                },1000)
                explaination.style.display = "block";

                progressBarFull.style.width = `${((currentQuestionIndex + 1) / questions.length) * 100}%`;
                if (attempt == 1) {
                    score++;
                    //post req -> correct++,qsnSolved++
                    // submit(true);
                }
                // else{
                //     //post req -> inCorrect++,qsnSolved++
                //     submit(false);
                // }
            } else {
                selectedBtn.classList.add("incorrect");
            }
        }

        function showScore() {
            submit();
            resetState();
            questionElement.innerHTML = `You Scored ${score} Out of ${questions.length}!`;
            nextButton.innerHTML = "Next Round";
            nextButton.style.display = "block";
            // EXAMPLE 3

            var ctx3 = document.getElementById("pieChart3");
            ctx3.style.display = "block";
            var pieChart3 = new Chart(ctx3, {
                type: 'pie',
                options: {
                    legend: {
                        position: 'left',
                        labels: {
                            boxWidth: 10,
                            fontStyle: 'italic',
                            fontColor: '#aaa',
                            usePointStyle: true,
                        }
                    },
                },
                data: {
                    labels: [
                        "Right",
                        "Wrong",
                    ],
                    datasets: [
                        {
                            data: [score, questions.length - score],
                            borderWidth: 5,
                            backgroundColor: [
                                '#A2C5AC',
                                "#DB6C79",
                            ],
                            hoverBackgroundColor: [
                                '#A2C5AC',
                                "#DB6C79",
                            ]
                        }]
                }
            });

            if(endQuote){
                quote.textContent = endQuote;
            }
            else{
                quote.textContent = "The mind is everything; what you think, you become. - Buddha";
            }
        }

        function handleNextButton() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                showQuestion();
            } else {
                showScore();
            }

        }

        nextButton.addEventListener("click", () => {
            if (currentQuestionIndex < questions.length) {
                handleNextButton();
            } else {
                // startQuiz();
                getQsns();

            }
        })

    </script>
    <%- include('partials/scriptlinks.ejs') %>
</body>

</html>